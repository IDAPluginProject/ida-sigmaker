name: ida-sigmaker tests

on:
    push:
        branches:
            - "main"
    pull_request:
        types:
            - synchronize
            - opened
            - reopened
            - ready_for_review
        branches:
            - "main"

# cancel previous workflow jobs for PRs
concurrency:
    group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.run_id }}
    cancel-in-progress: true

jobs:
    unit-tests:
        runs-on: ubuntu-24.04
        strategy:
            matrix:
                python-version: ["3.13"]
        env:
            PYTHONPATH: ${{ github.workspace }}
        steps:
            - name: "Checkout ${{ github.ref }} ( ${{ github.sha }} )"
              uses: actions/checkout@v4
              with:
                  persist-credentials: false

            - name: Set up Python${{ matrix.python-version }}
              uses: actions/setup-python@v5
              with:
                  python-version: ${{ matrix.python-version }}
                  # cache: "pip"

            - name: Login to GHCR (only if private)
              uses: docker/login-action@v3
              with:
                  registry: ghcr.io
                  username: ${{ github.actor }}
                  password: ${{ secrets.GHCR_TOKEN }}

            - name: Try logging in to GHCR
              run: |
                  echo "${{ secrets.GHCR_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin

            - name: Create a .env file if it doesn't exist
              run: |
                  if [ ! -f .env ]; then
                      echo "Creating .env file..."
                      touch .env
                  fi

            - name: Cache Docker image
              uses: actions/cache@v4
              with:
                  path: /tmp/docker-cache
                  key: docker-image-${{ runner.os }}-idapro-baked-${{ github.sha }}
                  restore-keys: |
                      docker-image-${{ runner.os }}-idapro-baked-

            - name: Load cached Docker image or pull fresh
              run: |
                  # Try to load from cache first
                  if [ -f /tmp/docker-cache/idapro-baked.tar ]; then
                      echo "Loading Docker image from cache..."
                      docker load < /tmp/docker-cache/idapro-baked.tar
                  else
                      echo "Cache miss, pulling fresh image..."
                      docker pull ghcr.io/mahmoudimus/idapro-linux:baked
                      # Save to cache for next run
                      mkdir -p /tmp/docker-cache
                      docker save ghcr.io/mahmoudimus/idapro-linux:baked > /tmp/docker-cache/idapro-baked.tar
                  fi

            - name: Run test_sigmaker.py
              run: |
                  docker compose run --rm idapro-tests test_sigmaker.py ||  { docker compose logs ; exit 1 ; }
                  docker compose logs
